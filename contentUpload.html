<!DOCTYPE html>
<html>
    <head>
        <title>Content Upload</title>
        <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="./css/jPages.css" />
		<link rel="stylesheet" type="text/css" href="./css/admin.css" />
    </head>
    <body>
    	<!-- V1: single-file -->
<!--     	<div class="container">
    		<div id="contentForm">
				<h3>Enter URL of New Content XML file:</h3>
				<form>
					<input type="text" name="content" id="link" />
					<div class="hint">Example: http://server2.tbw.ri.cmu.edu/CafeTeach/SilviaPessoa/data/qs-ao16hdblr8cu65ns445pqbtqn2.xml</div>
				</form> 
				<button id='submit' class="btn">Submit</button>
				<div id="update-success" class="alert alert-success">
					<strong>Update success!</strong> Please restart the game for changes to take effect.
				</div>
				<div id="update-error" class="alert alert-error">
					<strong>Uh-oh!</strong> Something went wrong. Please try submitting again.
				</div>
				<div id="update-error-format" class="alert alert-error">
					<strong>Uh-oh!</strong> The format of the file that you entered seems incorrect. Please check that you have copied the correct link.
				</div>
			</div>
		</div> -->


		<!-- V2: multiple files -->

		<div class="container" id="contentUpload">
    		<div id="contentForm">
				<h3>Upload New Question Set</h3>
				<form>
					<!-- <div class="control-group">
						<label>Name</label>
						<input type="text" name="contentName" id="contentName" />
					</div> -->
					<div class = "control-group">
						<label>Difficulty</label>
						<div class="btn-group" data-toggle="buttons-radio" id="difficulty">
  							<button type="button" class="btn btn-primary" id="basic">Basic Beginner</button>
  							<button type="button" class="btn btn-primary" id="beginner">Beginner</button>
  							<button type="button" class="btn btn-primary" id="intermediate">Intermediate</button>
						</div>
					</div>
					<div class="control-group">
						<label>URL of XML file</label>
						<input type="text" name="content" id="link" />
						<div class="hint">Example: http://server2.tbw.ri.cmu.edu/CafeTeach/SilviaPessoa/data/qs-ao16hdblr8cu65ns445pqbtqn2.xml</div>
					</div>
				</form> 
				<button id='submit' class="btn">Submit</button>
				<div id="update-success" class="alert alert-success">
					<strong>Update success!</strong> Please restart the game for changes to take effect.
				</div>
				<div id="update-error" class="alert alert-error">
					<strong>Uh-oh!</strong> Something went wrong. Please try submitting again.
				</div>
				<div id="update-error-format" class="alert alert-error">
					<strong>Uh-oh!</strong> Incorrect file format. Please check that you have copied the correct link.
				</div>
			</div>

			<div id="existingList">
				<h3>Existing Question Sets</h3>
				<table class="table table-hover" id="existingTable">
					<thead>
<!-- 						<tr>
							<th>#</th>
							<th>Name</th>
							<th>Date Added</th>
						</tr> -->
					</thead>
					<!-- <tr onclick="window.open('http://www.google.com');">
						<td>1</td>
						<td>Monday noon</td>
						<td>22 March 2013</td>
					</tr>
					<tr onclick="window.open('http://www.google.com');">
						<td>2</td>
						<td>Monday 5pm</td>
						<td>22 March 2013</td>
					</tr>
					<tr onclick="window.open('http://www.google.com');">
						<td>3</td>
						<td>Tuesday noon</td>
						<td>23 March 2013</td>
					</tr>
					<tr onclick="window.open('http://www.google.com');">
						<td>4</td>
						<td>Monday 5pm v2</td>
						<td>23 March 2013</td>
					</tr>
					<tr onclick="window.open('http://www.google.com');">
						<td>5</td>
						<td>Monday noon</td>
						<td>22 March 2013</td>
					</tr>
					<tr onclick="window.open('http://www.google.com');">
						<td>6</td>
						<td>Monday 5pm</td>
						<td>22 March 2013</td>
					</tr>
					<tr onclick="window.open('http://www.google.com');">
						<td>7</td>
						<td>Tuesday noon</td>
						<td>23 March 2013</td>
					</tr>
					<tr onclick="window.open('http://www.google.com');">
						<td>8</td>
						<td>Monday 5pm v2</td>
						<td>23 March 2013</td>
					</tr> -->
				</table>
			</div>
		</div>

		<div class="modal hide fade" id="questionSetViewer">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h3 id="questionSetName">Modal header</h3>
			</div>
			<div class="modal-body">
				
			</div>
		</div>

	<script src = "js/jquery.min.js" type="text/javascript"></script>
	<script type="text/javascript" src="./js/bootstrap.min.js"></script>
	<script>
		var num = "Basic Beginner";

		var ajaxPost = function(json, url, onSuccess, onError){
		    var data = new FormData();

		    for (var key in json){
		        data.append(key, json[key]);
		    }
		    
		        $.ajax({
		            url: url,
		            data: data,
		            cache: false,
		            contentType: false,
		            processData: false,
		            type: 'POST',
		            success: onSuccess,
		            error: onError});
		}

		var ajaxRequest = function(url, fnSuccess, fnError){
	        $.ajax({
	            url: url,
	            data: 'GET',
	            success: fnSuccess,
	            error: fnError
	        });
	    }; 

	    window.onload = function(){
        	$('.nav-tabs').button();
        	$('#basic').button('toggle');
			$(".btn-group > button.btn").on("click", function(){
    			num = this.innerHTML;
			});

			ajaxRequest('/register', function(data){
				// console.log(data); 
				var basicData;
				var beginnerData;
				var intermediateData;
				for(var i = 0; i < data.length; i++) {
					$("#existingTable").append("<tr class='existingFile'><td>"+data[i].name+"</td></tr>");
					if (data[i].name === "Basic Beginner"){
						basicData = data[i].data;
						$("#existingTable .existingFile").last().attr('id', 'basic');
					}
					else if (data[i].name === "Beginner"){
						beginnerData = data[i].data;
						$("#existingTable .existingFile").last().attr('id', 'beginner');
					}
					else if (data[i].name === "Intermediate"){
						intermediateData = data[i].data;
						$("#existingTable .existingFile").last().attr('id', 'intermediate');
					}
				}
				$(".existingFile").on("click",function(){
					var level = $(this).attr('id');
					var questionSet;
					if (level === "basic"){
						questionSet = basicData;
						$("#questionSetName").html("Basic Beginner Question Set");
					}
					else if (level === "beginner"){
						questionSet = beginnerData;
						$("#questionSetName").html("Beginner Question Set");
					}
					else if (level === "intermediate"){
						questionSet = intermediateData;
						$("#questionSetName").html("Intermediate Question Set");
					}

					// populate questions
					$("#questionSetViewer .modal-body").html('');
					for (var i=0; i<questionSet.length; i++){
						var questionData = JSON.parse(questionSet[i]);
						var index = i+1;
						var $question = $('\
							<table class="question table table-bordered">\
								<tr>\
									<td class="index" rowspan=2>'+index+'</td>\
									<td class="question" colspan=8>'+questionData.q+'</td>\
								</tr>\
								<tr class="answers">\
								</tr>\
							</table>');
						for (var j=0; j<questionData.choices.length; j++){
							$question.find(".answers").append('<td>'+questionData.choices[j]+'</td>')
							if (questionData.choices[j] === questionData.a){
								$question.find(".answers td").last().addClass("correct")
							}
						}
						$("#questionSetViewer .modal-body").append($question);
					};
					
					$('#questionSetViewer').modal('show');
				});
			}, function(err){console.log(err);})

    	}
		
	    // ajaxRequest('/register', function(data){console.log(data);}, function(err){console.log(err);})

	    $('#submit').bind('click', execute);

		function execute(){
			var xmlURL = $('#link').val();
			var contentName = num;
			console.log(num);

			// error checking
			if (xmlURL.substring(0,7)!=="http://"){
				console.log(xmlURL.substring(0,7));
				xmlURL = "http://"+xmlURL;
			}
			if (xmlURL.substring(xmlURL.length-4, xmlURL.length)!==".xml"){
				console.log(xmlURL.substring(xmlURL.length-4, xmlURL.length));
				$("#update-error").hide();
				$("#update-success").hide();
				$("#update-error-format").hide();
				$("#update-error-format").fadeIn();
			}
			else{
				console.log(xmlURL);

				if (!(xmlURL=='')){
					ajaxPost({
						url:xmlURL,
						name:contentName
					},
					'/updateXML',
					function(data){
						console.log(data);
						$("#update-error").hide();
						$("#update-error-format").hide();
						$("#update-success").hide();
						$("#update-success").fadeIn();
					},
					function(err){
						console.log(err);
						$("#update-success").hide();
						$("#update-error").hide();
						$("#update-error-format").hide();
						$("#update-error").fadeIn();
					});
				}
			}

			
		}

	</script>

</body>
</html>
